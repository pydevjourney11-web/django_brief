{% load static briefs_extras %}
<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ brief.title }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <link rel="stylesheet" href="{% static 'briefs/fill_brief.css' %}" />
  </head>

  <body>
    <div
      class="container"
      data-brief-uuid="{{ brief.public_uuid }}"
      data-brief-completed="{% if brief.status == brief.Status.COMPLETED %}1{% else %}0{% endif %}"
      data-autosave-url="{% url 'briefs:brief_autosave' brief.public_uuid %}"
    >
      {% if logo_url %}
      <div class="logo-wrap">
        <img src="{{ logo_url }}" alt="Logo" />
      </div>
      {% endif %}
      <div class="content">
      <header class="brief-header">
        <div class="header-row">
          <div class="header-left">
            <div class="title-row">
              <h1 class="main">{{ header_title|default:brief.title }}</h1>
              {% if header_subtitle %}
                <div class="sub">{{ header_subtitle|linebreaksbr }}</div>
              {% elif brief.description %}
                <div class="sub">{{ brief.description|linebreaksbr }}</div>
              {% endif %}
            </div>
          </div>
          <div class="header-right">
            <div class="date-wrap">
              {% if calendar_icon_url %}
                <img class="date-icon" src="{{ calendar_icon_url }}" alt="" />
              {% else %}
                <svg class="date-icon" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5 16.5H7.5C4.67157 16.5 3.25736 16.5 2.37868 15.6213C1.5 14.7427 1.5 13.3284 1.5 10.5V9C1.5 6.17157 1.5 4.75736 2.37868 3.87868C3.25736 3 4.67157 3 7.5 3H10.5C13.3284 3 14.7427 3 15.6213 3.87868C16.5 4.75736 16.5 6.17157 16.5 9V10.5C16.5 13.3284 16.5 14.7427 15.6213 15.6213C15.1314 16.1112 14.4751 16.328 13.5 16.4239" stroke="#3B507D" stroke-linecap="round"/><path d="M5.25 3V1.875" stroke="#3B507D" stroke-linecap="round"/><path d="M12.75 3V1.875" stroke="#3B507D" stroke-linecap="round"/><path d="M16.125 6.75H12.4688H8.0625M1.5 6.75H4.40625" stroke="#3B507D" stroke-linecap="round"/></svg>
              {% endif %}
              <input class="date-input" type="text" readonly value="{{ brief.created_at|date:"d.m.Y" }}" />
            </div>
          </div>
        </div>

        {% if header_description %}
          <div class="brief-lead">{{ header_description }}</div>
        {% endif %}
      </header>

      <section class="block">
        <div class="fields-grid header-contacts-grid">
          {% for item in header_items %}
            {% with q=item.q icon=item.icon_url %}
            <div class="q">
              <label class="q-label" for="q-{{ q.id }}">{{ q.label }}</label>
              <div class="input-wrap">
                {% if icon %}<img class="q-icon" src="{{ icon }}" alt="" />{% endif %}
                <input id="q-{{ q.id }}" type="text" data-question-id="{{ q.id }}" data-question-type="{{ q.type }}" placeholder="{{ q.label }}" value="{{ answers_by_question_id|get_item:q.id|default_if_none:q.default_value|default_if_none:'' }}" {% if brief.status == brief.Status.COMPLETED %}disabled{% endif %} />
              </div>
            </div>
            {% endwith %}
          {% endfor %}
        </div>
      </section>

      <div id="submittedNotice" class="notice">Форма отправлена. Спасибо!</div>

      {% for block in blocks %}
        <section class="block">
          <h2 class="block-title">{{ block.title }}</h2>
          {% if block.description %}
            <div class="block-desc">{{ block.description }}</div>
          {% endif %}

          <div class="fields-grid" data-cols="{{ block_cols|get_item:block.id }}">
          {% for q in block.questions.all %}
            {% if not q.id in header_question_ids %}
            <div class="q {% if q.type == q.QuestionType.TEXT or q.is_multiple or q.repeater_schema %}q--full{% endif %}">
              <div class="q-inner">
                <label class="q-label" for="q-{{ q.id }}">{{ q.label }}</label>

              {% if q.repeater_schema %}
                <div class="competitors-repeater" data-question-id="{{ q.id }}" data-min-rows="{{ q.repeater_min_rows|default:5 }}" style="--cols: {{ q.repeater_schema|length|default:2 }}">
                  <div class="comp-head">
                    {% for col in q.repeater_schema %}
                      {% with label=col.label|default:col %}
                        {% with k=col.key|default:label|slugify %}
                          <div class="comp-col" data-key="{{ k }}" data-placeholder="{{ col.placeholder|default:'' }}">{{ label }}</div>
                        {% endwith %}
                      {% endwith %}
                    {% endfor %}
                  </div>
                  <div class="comp-rows"></div>
                  <div class="comp-actions">
                    <button type="button" class="btn add-comp-row" {% if brief.status == brief.Status.COMPLETED %}disabled{% endif %}>Добавить строку</button>
                  </div>
                  <input type="hidden" class="competitors-hidden" data-question-id="{{ q.id }}" data-question-type="{{ q.type }}" value="{{ answers_by_question_id|get_item:q.id|default_if_none:q.default_value|default_if_none:'' }}" />
                </div>
              {% elif q.type == q.QuestionType.STRING %}
                <input
                  id="q-{{ q.id }}"
                  type="text"
                  data-question-id="{{ q.id }}"
                  data-question-type="{{ q.type }}"
                  placeholder="{{ q.placeholder }}"
                  value="{{ answers_by_question_id|get_item:q.id|default_if_none:q.default_value|default_if_none:'' }}"
                  {% if brief.status == brief.Status.COMPLETED %}disabled{% endif %}
                />

              {% elif q.type == q.QuestionType.TEXT %}
                <textarea
                  id="q-{{ q.id }}"
                  data-question-id="{{ q.id }}"
                  data-question-type="{{ q.type }}"
                  placeholder="{{ q.placeholder }}"
                  {% if brief.status == brief.Status.COMPLETED %}disabled{% endif %}
                >{{ answers_by_question_id|get_item:q.id|default_if_none:q.default_value|default_if_none:'' }}</textarea>

              {% elif q.type == q.QuestionType.INT %}
                <input
                  id="q-{{ q.id }}"
                  type="number"
                  step="1"
                  data-question-id="{{ q.id }}"
                  data-question-type="{{ q.type }}"
                  placeholder="{{ q.placeholder }}"
                  value="{{ answers_by_question_id|get_item:q.id|default_if_none:q.default_value|default_if_none:'' }}"
                  {% if brief.status == brief.Status.COMPLETED %}disabled{% endif %}
                />

              {% elif q.type == q.QuestionType.FLOAT %}
                <input
                  id="q-{{ q.id }}"
                  type="number"
                  step="any"
                  data-question-id="{{ q.id }}"
                  data-question-type="{{ q.type }}"
                  placeholder="{{ q.placeholder }}"
                  value="{{ answers_by_question_id|get_item:q.id|default_if_none:q.default_value|default_if_none:'' }}"
                  {% if brief.status == brief.Status.COMPLETED %}disabled{% endif %}
                />

              {% elif q.type == q.QuestionType.SELECT %}
                {% if q.is_multiple %}
                  {% with current=answers_by_question_id|get_item:q.id|default_if_none:q.default_value %}
                  {% if q.choices_header_left or q.choices_header_right %}
                  <div class="check-head">
                    <div></div>
                    <div class="check-head-left">{{ q.choices_header_left }}</div>
                    <div class="check-head-right">{{ q.choices_header_right }}</div>
                  </div>
                  {% endif %}
                  <div class="check-list">
                    {% for opt in q.options.all %}
                      <label class="check-row">
                        <input type="checkbox" data-question-id="{{ q.id }}" data-question-type="{{ q.type }}" value="{{ opt.value }}" {% if current and opt.value in current %}checked{% endif %} {% if brief.status == brief.Status.COMPLETED %}disabled{% endif %} />
                        <span class="check-title">{{ opt.label }}</span>
                        {% if opt.description %}<span class="check-desc">{{ opt.description }}</span>{% endif %}
                      </label>
                    {% endfor %}
                  </div>
                  {% endwith %}
                {% else %}
                  <select
                    id="q-{{ q.id }}"
                    data-question-id="{{ q.id }}"
                    data-question-type="{{ q.type }}"
                    {% if brief.status == brief.Status.COMPLETED %}disabled{% endif %}
                  >
                    <option value="">-- выберите --</option>
                    {% with current=answers_by_question_id|get_item:q.id|default_if_none:q.default_value %}
                      {% for opt in q.options.all %}
                        <option value="{{ opt.value }}" {% if current == opt.value %}selected{% endif %}>{{ opt.label }}</option>
                      {% endfor %}
                    {% endwith %}
                  </select>
                {% endif %}
              {% endif %}

              {% if q.placeholder %}
                <div class="q-help">{{ q.placeholder }}</div>
              {% endif %}
              </div>
            </div>
            {% endif %}
          {% endfor %}
          </div>
        </section>
      {% endfor %}
      </div>

      <div class="actions">
        <form method="post" action="{% url 'briefs:brief_submit' brief.public_uuid %}">
          {% csrf_token %}
          <button class="btn" type="submit" {% if brief.status == brief.Status.COMPLETED %}disabled{% endif %}>
            Отправить бриф
          </button>
        </form>

        {% if brief.status != brief.Status.COMPLETED %}
        <div id="saveIndicator" class="save-indicator muted">Изменения сохраняются автоматически.</div>
        {% endif %}
      </div>
    </div>

    <!-- Submitted modal -->
    <div id="submittedOverlay" class="submitted-overlay"></div>
    <div id="submittedDialog" class="submitted-dialog" role="dialog" aria-modal="true" aria-labelledby="submittedTitle">
      <button type="button" class="submitted-close" aria-label="Закрыть">×</button>
      <img class="submitted-icon" src="{% static 'send-paper-svgrepo-com 1.png' %}" alt="" />
      <div id="submittedTitle" class="submitted-title">Бриф отправлен</div>
      <div class="submitted-text">Мы свяжемся с вами в ближайшее время
для уточнения деталей</div>
      <div class="submitted-actions">
        <a class="btn-back" href="/">Вернуться на главную</a>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="{% static 'briefs/fill_brief.js' %}"></script>
  </body>
</html>
